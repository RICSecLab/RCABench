#!/bin/bash

set -eu

. ${TARGET_ROOT}/config.sh

if [ $# -lt 1 ]; then
  echo "Usage: $0 <build dir name>" 1>&2
  exit 1
fi

cd $TARGET_ROOT

wget https://www.php.net/distributions/php-7.3.5.tar.gz
tar xf php-7.3.5.tar.gz 
mv php-7.3.5 $1
cd $1

patch ./Zend/zend_portability.h ${TARGET_ROOT}/zend_portability.h.patch

TARGET_DEF_CFLAGS="${TARGET_DEF_CFLAGS-} -no-pie -fno-pie"
TARGET_DEF_CXXFLAGS="${TARGET_DEF_CXXFLAGS-} -no-pie -fno-pie"
TARGET_DEF_LDFLAGS="${TARGET_DEF_CXXFLAGS-} -no-pie -fno-pie"
ARGS=""
for var in "${!TARGET_DEF_@}"; do
	tmp=${!var//\-fsanitize\=address/\-fsanitize\=memory}
	tmp=${tmp//gcc/clang}
	tmp=${tmp//g++/clang++}
	ARGS="${ARGS} ${var#TARGET_DEF_}=\"$(echo ${tmp})\""
done

eval ./configure CC=clang CXX=clang++ ${ARGS} --prefix=/dir_name/install --with-gd --enable-cli --without-pear
eval make ${ARGS} -j$(nproc)

#export ZEND_DONT_UNLOAD_MODULES=1
#export USE_ZEND_ALLOC=0
#UBSAN_OPTIONS="print_stacktrace=1" ./sapi/cli/php ../xbm.php
