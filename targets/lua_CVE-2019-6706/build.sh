#!/bin/bash
set -eu

. ${TARGET_ROOT}/config.sh

if [ $# -lt 1 ]; then
  echo "Usage: $0 <build dir name>" 1>&2
  exit 1
fi

cd ${TARGET_ROOT}
git clone --branch v5.3.5 --depth 1 https://github.com/lua/lua.git $1
cd ${TARGET_ROOT}/$1

TARGET_DEF_CFLAGS="${TARGET_DEF_CFLAGS-}"
TARGET_DEF_LDFLAGS="${TARGET_DEF_LDFLAGS-}"
for var in "${!TARGET_DEF_@}"; do
  eval "${var#TARGET_DEF_}"="$(printf "%q" "${!var}")"
done

sed -i "s/-O2/-O0/g" makefile
sed -i -e "/^MYCFLAGS/s/$/ $(printf "%q" "${CFLAGS}")/g" makefile
sed -i -e "/^MYLDFLAGS/s/$/ $(printf "%q" "${LDFLAGS}")/g" makefile
make CC=${TARGET_DEF_CC-gcc} -j$((`nproc`+1))
